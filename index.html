<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmoGentileza Tech - Relatório Mensal das Fichas de Stock (OFFLINE)</title>
    <!-- Carregamento do Tailwind CSS para um design moderno e responsivo --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter (padrão de design) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Estilo para botões de ação e voz */
        .btn-primary {
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .voice-active {
            animation: pulse-mic 1s infinite alternate;
        }
        @keyframes pulse-mic {
            from { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
            to { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
        }
    </style>
</head>
<body>

    <!-- Estrutura Principal da Aplicação --><div class="min-h-screen p-4 sm:p-6 lg:p-8">

        <!-- Cabeçalho --><header class="bg-white shadow-lg rounded-xl p-5 mb-6 flex flex-col items-center">
            <h1 class="text-3xl font-extrabold text-gray-800 text-center">FarmoGentileza</h1>
            <h2 class="text-xl font-semibold text-gray-700 text-center mt-1">FarmoGentileza Tech</h2>
            <p class="text-gray-500 mt-1 text-center">Projeto: Relatório Mensal das Fichas de Stock - Automatização por Entrada de Voz</p>
            <div id="user-info" class="mt-3 text-sm font-medium text-red-600 text-center font-bold">
                A aplicação está a funcionar em **MODO OFFLINE**. Os dados são guardados apenas no seu navegador.
            </div>
        </header>

        <!-- Seção de Entrada de Dados (A Ficha de Stock Digital) --><section class="bg-white shadow-xl rounded-xl p-6 mb-6 border-t-4 border-indigo-500">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                Registar Nova Dispensa
            </h2>

            <!-- Formulário de Registo --><div class="space-y-4">
                <div>
                    <label for="productName" class="block text-sm font-medium text-gray-700">1. Nome do Produto</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="productName" class="flex-1 block w-full rounded-l-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3 sm:text-sm" placeholder="Ex: Paracetamol 500mg" required>
                        <button id="btnVoiceName" class="bg-indigo-500 text-white p-3 rounded-r-lg hover:bg-indigo-600 transition duration-150 ease-in-out" title="Gravar Nome por Voz">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M10 9a6 6 0 00-6 6v2a2 2 0 002 2h8a2 2 0 002-2v-2a6 6 0 00-6-6z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>

                <div>
                    <label for="productType" class="block text-sm font-medium text-gray-700">2. Tipo (Dosagem/Formato)</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="productType" class="flex-1 block w-full rounded-l-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3 sm:text-sm" placeholder="Ex: Comprimidos / Xarope / 10mg" required>
                        <button id="btnVoiceType" class="bg-indigo-500 text-white p-3 rounded-r-lg hover:bg-indigo-600 transition duration-150 ease-in-out" title="Gravar Tipo por Voz">
                             <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M10 9a6 6 0 00-6 6v2a2 2 0 002 2h8a2 2 0 002-2v-2a6 6 0 00-6-6z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>

                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-700">3. Quantidade (Número de Unidades)</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="number" id="quantity" class="flex-1 block w-full rounded-l-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3 sm:text-sm" placeholder="Ex: 50" min="1" required>
                        <button id="btnVoiceQuantity" class="bg-indigo-500 text-white p-3 rounded-r-lg hover:bg-indigo-600 transition duration-150 ease-in-out" title="Gravar Quantidade por Voz">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M10 9a6 6 0 00-6 6v2a2 2 0 002 2h8a2 2 0 002-2v-2a6 6 0 00-6-6z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Botão de Submissão/Atualização --><button id="btnSaveDispense" class="btn-primary mt-6 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                <span id="save-text">Registar Dispensa</span>
                <span id="loading-spinner" class="hidden animate-spin h-5 w-5 border-t-2 border-b-2 border-white rounded-full ml-2"></span>
            </button>

            <!-- Mensagens de Estado --><div id="status-message" class="mt-4 text-center text-sm font-medium hidden"></div>

        </section>

        <!-- Seção de Relatórios e Dados Recentes --><section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Card de Geração de Relatório --><div class="lg:col-span-1 bg-white shadow-xl rounded-xl p-6 border-t-4 border-yellow-500">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Gerar Relatório Mensal
                </h2>
                <p class="text-gray-600 mb-4 text-sm">Esta função agrega automaticamente todas as dispensas registadas no período, eliminando a contagem manual da ficha de stock.</p>

                <div class="flex flex-col space-y-3">
                    <label for="reportMonth" class="block text-sm font-medium text-gray-700">Mês do Relatório</label>
                    <input type="month" id="reportMonth" class="p-2 border border-gray-300 rounded-lg">
                </div>

                <!-- Botão alterado para refletir o novo formato (.doc) --><button id="btnGenerateReport" class="btn-primary mt-4 w-full bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2">
                    Gerar e Descarregar Relatório (DOC - Word)
                </button>

                <!-- Botão Limpar Registo --><button id="btnClearDispenses" class="btn-primary mt-4 w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    Limpar TODOS os Registos (Atenção!)
                </button>
            </div>

            <!-- Lista de Registos Recentes (Dados em Tempo Real) --><div class="lg:col-span-2 bg-white shadow-xl rounded-xl p-6 border-t-4 border-purple-500">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                    Todos os Registos de Dispensa (Localmente)
                </h2>
                <div id="dispenses-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-center text-gray-400 p-4" id="no-data-msg">A carregar registos...</p>
                </div>
            </div>

        </section>

    </div>

    <!-- Script de Configuração e Lógica da Aplicação --><script>
        // Variável de chave para o armazenamento local
        const STORAGE_KEY = 'farmoGentilezaDispenses';
        // Variável global para rastrear o ID do registo que está a ser editado
        let editingDispenseId = null; 

        /**
         * Funções de Acesso ao LocalStorage
         */
        function getDispensesFromStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Erro ao ler do localStorage:", e);
                return [];
            }
        }

        function saveDispensesToStorage(dispenses) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dispenses));
            } catch (e) {
                console.error("Erro ao guardar no localStorage:", e);
                showStatus('Erro ao guardar os dados. O armazenamento local pode estar cheio.', 'text-red-500');
            }
        }

        /**
         * Inicializa a aplicação (substituindo o setupFirebase).
         */
        function setupApp() {
            // No modo offline, a aplicação está sempre "pronta"
            document.getElementById('user-info').textContent = 'Modo Offline Ativo. Os dados são salvos localmente no seu navegador.';
            loadDispenses(); 
        }

        /**
         * Configura o sistema de Reconhecimento de Voz.
         * (Mantido do código anterior, pois funciona sem internet).
         * @param {HTMLElement} inputElement O campo de input a preencher.
         * @param {string} prompt A mensagem de prompt para o utilizador.
         */
        function setupVoiceRecognition(inputElement, prompt) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showStatus('O reconhecimento de voz não é suportado no seu browser/dispositivo.', 'text-red-500');
                return null;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-PT'; // Definir para Português
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const voiceButton = inputElement.nextElementSibling; // Assume que o botão de voz é o próximo irmão

            voiceButton.onclick = () => {
                try {
                    recognition.start();
                    // Não limpar o input no modo de edição (o utilizador pode querer editar uma parte)
                    if (!editingDispenseId) {
                         inputElement.value = ''; 
                    }
                    voiceButton.classList.add('voice-active');
                    showStatus(`A ouvir para ${prompt}... Diga claramente.`, 'text-indigo-600');
                } catch (e) {
                    console.warn("Reconhecimento de Voz já ativo ou erro ao iniciar:", e);
                    recognition.stop();
                    voiceButton.classList.remove('voice-active');
                }
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                inputElement.value = transcript.trim();
                showStatus(`Registo de ${prompt} capturado: "${transcript.trim()}"`, 'text-green-600');

                // Tentar automaticamente mover para o próximo campo
                if (inputElement.id === 'productName') {
                    document.getElementById('productType').focus();
                } else if (inputElement.id === 'productType') {
                    document.getElementById('quantity').focus();
                }
            };

            recognition.onerror = (event) => {
                console.error('Erro de Reconhecimento de Voz:', event.error);
                voiceButton.classList.remove('voice-active');
                let errorMsg = 'Erro na voz. Verifique a permissão do microfone.';
                if (event.error === 'not-allowed') {
                    errorMsg = 'Acesso ao Microfone negado. Por favor, permita no seu dispositivo.';
                }
                showStatus(errorMsg, 'text-red-500');
            };

            recognition.onend = () => {
                voiceButton.classList.remove('voice-active');
            };
        }

        /**
         * Exibe uma mensagem de estado temporária.
         * @param {string} message A mensagem a exibir.
         * @param {string} className A classe CSS para cor/estilo.
         */
        function showStatus(message, className) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `mt-4 text-center text-sm font-medium ${className}`;
            statusEl.style.display = 'block';

            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        /**
         * Limpa os campos de input e reseta o botão, saindo do modo de edição.
         */
        function cancelEdit() {
            editingDispenseId = null;
            document.getElementById('productName').value = '';
            document.getElementById('productType').value = '';
            document.getElementById('quantity').value = '';

            // Resetar o botão para o modo de Registo
            const btnSave = document.getElementById('btnSaveDispense');
            document.getElementById('save-text').textContent = 'Registar Dispensa';
            btnSave.classList.replace('bg-indigo-600', 'bg-green-600');
            btnSave.classList.replace('hover:bg-indigo-700', 'hover:bg-green-700');
        }

        /**
         * Guarda um novo registo ou atualiza um existente no LocalStorage.
         */
        async function saveOrUpdateDispense() {
            const productName = document.getElementById('productName').value.trim();
            const productType = document.getElementById('productType').value.trim();
            const quantityStr = document.getElementById('quantity').value.trim();
            const quantity = parseInt(quantityStr, 10);

            if (!productName || !productType || isNaN(quantity) || quantity <= 0) {
                showStatus('Por favor, preencha todos os campos corretamente (Nome, Tipo e Quantidade > 0).', 'text-red-500');
                return;
            }

            // Exibir carregamento
            const btnSave = document.getElementById('btnSaveDispense');
            const saveText = document.getElementById('save-text');
            const spinner = document.getElementById('loading-spinner');
            const originalText = saveText.textContent;
            
            saveText.textContent = editingDispenseId ? 'A Atualizar...' : 'A Guardar...';
            spinner.classList.remove('hidden');
            btnSave.disabled = true;

            try {
                let currentDispenses = getDispensesFromStorage();
                let successMessage = '';

                if (editingDispenseId) {
                    // Modo Edição (Update)
                    const index = currentDispenses.findIndex(d => d.id === editingDispenseId);

                    if (index !== -1) {
                        currentDispenses[index].productName = productName;
                        currentDispenses[index].productType = productType;
                        currentDispenses[index].quantityDispensed = quantity;
                        // Mantemos o timestamp original para efeitos de relatório
                        successMessage = `Registo de ${productName} atualizado com sucesso!`;
                    } else {
                        throw new Error("ID de edição não encontrado na lista.");
                    }
                } else {
                    // Modo Novo Registo (Save)
                    const newDispense = {
                        id: Date.now().toString(), // ID único baseado no tempo
                        productName: productName,
                        productType: productType,
                        quantityDispensed: quantity,
                        timestamp: Date.now(), // Tempo em milissegundos
                        dispenseDate: new Date().toISOString().split('T')[0], // Data YYYY-MM-DD
                    };
                    currentDispenses.push(newDispense);
                    successMessage = `Dispensa de ${productName} (Qtd: ${quantity}) registada com sucesso!`;
                }

                saveDispensesToStorage(currentDispenses);
                showStatus(successMessage + ' (Salva localmente)', 'text-green-600');

                // Limpar/Resetar UI após o sucesso
                cancelEdit(); 
                loadDispenses(); // Atualizar a lista local
            } catch (e) {
                console.error("Erro ao adicionar/atualizar registo local:", e);
                showStatus(`Erro ao guardar o registo: ${e.message}`, 'text-red-500');
            } finally {
                // Ocultar carregamento
                saveText.textContent = originalText;
                spinner.classList.add('hidden');
                btnSave.disabled = false;
            }
        }
        
        /**
         * Funçao para eliminar um registo individual pelo seu ID.
         * @param {string} id O ID único do registo a eliminar.
         */
        function deleteDispense(id) {
            try {
                let currentDispenses = getDispensesFromStorage();
                
                // Filtra o array, mantendo apenas os elementos cujo ID não corresponde ao ID a ser eliminado.
                const updatedDispenses = currentDispenses.filter(dispense => dispense.id !== id);

                if (updatedDispenses.length < currentDispenses.length) {
                    saveDispensesToStorage(updatedDispenses);
                    showStatus('Registo eliminado com sucesso. A lista foi atualizada.', 'text-red-600');
                    loadDispenses(); // Recarrega a lista para atualizar a UI
                    cancelEdit(); // Sai do modo de edição se o registo apagado for o que estava a ser editado
                } else {
                    showStatus('Erro: O registo não foi encontrado.', 'text-orange-500');
                }
            } catch (e) {
                console.error("Erro ao eliminar registo local:", e);
                showStatus(`Erro ao eliminar registo: ${e.message}`, 'text-red-500');
            }
        }

        /**
         * Funçao para carregar os dados de um registo no formulário para edição.
         * @param {string} id O ID único do registo a editar.
         */
        function editDispense(id) {
            const dispenses = getDispensesFromStorage();
            const dispenseToEdit = dispenses.find(d => d.id === id);

            if (dispenseToEdit) {
                // 1. Preencher os campos do formulário
                document.getElementById('productName').value = dispenseToEdit.productName;
                document.getElementById('productType').value = dispenseToEdit.productType;
                document.getElementById('quantity').value = dispenseToEdit.quantityDispensed;

                // 2. Mudar o estado para edição
                editingDispenseId = id;

                // 3. Mudar o texto e cor do botão de salvar para Atualizar
                const btnSave = document.getElementById('btnSaveDispense');
                document.getElementById('save-text').textContent = 'Atualizar Registo';
                btnSave.classList.replace('bg-green-600', 'bg-indigo-600');
                btnSave.classList.replace('hover:bg-green-700', 'hover:bg-indigo-700');
                
                showStatus('A editar o registo. Altere os campos e clique em "Atualizar Registo".', 'text-indigo-600');
                document.getElementById('productName').focus(); // Foco no primeiro campo
            } else {
                showStatus('Erro: Registo a editar não encontrado.', 'text-red-500');
            }
        }


        /**
         * Carrega os registos de dispensa do LocalStorage.
         */
        function loadDispenses() {
            try {
                const dispenses = getDispensesFromStorage();

                // Ordenar em memória (descendente)
                dispenses.sort((a, b) => b.timestamp - a.timestamp); 

                // Carrega todos os registos.
                renderDispenses(dispenses);
            } catch (error) {
                console.error("Erro ao carregar dispensas locais:", error);
                document.getElementById('no-data-msg').textContent = 'Erro ao carregar dados do armazenamento local.';
            }
        }

        /**
         * Renderiza a lista de dispensas recentes no UI.
         * ATUALIZADO: Adiciona botões de editar e eliminar a cada item.
         * @param {Array} dispenses Array de objetos de dispensa.
         */
        function renderDispenses(dispenses) {
            const listEl = document.getElementById('dispenses-list');
            listEl.innerHTML = '';

            if (dispenses.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-400 p-4">Não há registos de dispensas.</p>';
                return;
            }

            dispenses.forEach(dispense => {
                // O timestamp é agora um número (milissegundos)
                const timestamp = new Date(dispense.timestamp);
                const timeString = timestamp.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
                const dateString = timestamp.toLocaleDateString('pt-PT');

                const item = document.createElement('div');
                item.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 hover:bg-gray-100 transition duration-150 relative'; 
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">${dispense.productName}</p>
                            <p class="text-sm text-gray-600">Tipo: ${dispense.productType}</p>
                            <p class="text-lg font-extrabold text-purple-600">Qtd: ${dispense.quantityDispensed}</p>
                            <p class="text-xs text-gray-400 mt-1">Registo: ${dateString} às ${timeString}</p>
                        </div>
                        <div class="flex space-x-2"> 
                            <!-- Botão de Editar Individual -->
                            <button onclick="editDispense('${dispense.id}')" 
                                    class="p-2 text-indigo-500 hover:text-indigo-700 bg-indigo-100 rounded-full transition duration-150 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                    title="Editar este registo">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <!-- Botão de Eliminar Individual -->
                            <button onclick="deleteDispense('${dispense.id}')" 
                                    class="p-2 text-red-500 hover:text-red-700 bg-red-100 rounded-full transition duration-150 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-500" 
                                    title="Eliminar este registo">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        /**
         * Gera o relatório mensal usando os dados do LocalStorage.
         * @param {string} monthYearString Data no formato 'YYYY-MM'.
         */
        async function generateReport(monthYearString) {
            if (!monthYearString) {
                showStatus('Por favor, selecione o Mês do Relatório.', 'text-red-500');
                return;
            }

            // Extrai MM/AAAA do formato YYYY-MM
            const [year, month] = monthYearString.split('-');
            const monthYearShort = `${month}/${year}`;

            // Exibir carregamento para o relatório
            const btnReport = document.getElementById('btnGenerateReport');
            const originalReportText = btnReport.textContent;
            btnReport.textContent = 'A Gerar...';
            btnReport.disabled = true;

            showStatus('A processar dados locais para o relatório...', 'text-yellow-600');
            
            try {
                // Carregar todos os dados do localStorage
                const allDispenses = getDispensesFromStorage();
                
                const aggregatedData = {};
                let totalRegistos = 0;

                allDispenses.forEach((data) => {
                    const dispDate = data.dispenseDate; // YYYY-MM-DD

                    if (dispDate && dispDate.startsWith(monthYearString)) {
                        const key = `${data.productName} | ${data.productType}`;
                        
                        if (!aggregatedData[key]) {
                            aggregatedData[key] = {
                                'Nome do Produto': data.productName,
                                'Tipo (Dosagem/Formato)': data.productType,
                                'Quantidade Dispensada': 0,
                            };
                        }
                        
                        aggregatedData[key]['Quantidade Dispensada'] += data.quantityDispensed;
                        totalRegistos++;
                    }
                });

                if (totalRegistos === 0) {
                    showStatus('Não foram encontrados registos para o mês selecionado.', 'text-red-500');
                    return;
                }

                // --- Geração do HTML para o Word (.doc) ---
                const dataArray = Object.values(aggregatedData);
                
                // Estrutura do documento HTML (com estilos embutidos para compatibilidade com o Word)
                let tableHtml = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head><meta charset='utf-8'></head>
                    <body>
                        <div style="font-family: Arial, sans-serif;">
                            <!-- NOVO CABEÇALHO SIMPLIFICADO -->
                            <h2 style="text-align: center; color: #4a5568; margin-top: 0; margin-bottom: 20px; font-size: 1.5em; font-weight: bold;">
                                Relatório dos Gastáveis de ${monthYearShort}
                            </h2>
                            <table border="1" style="width: 100%; border-collapse: collapse;">
                                <!-- Cabeçalho --><tr style="background-color: #e0f2fe; color: #1e3a8a; font-weight: bold;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #aaa;">Nome do Produto</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #aaa;">Tipo (Dosagem/Formato)</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #aaa;">Quantidade Dispensada</th>
                                </tr>
                `;

                // Linhas da Tabela
                dataArray.forEach(item => {
                    tableHtml += '<tr>';
                    tableHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${item['Nome do Produto']}</td>`;
                    tableHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${item['Tipo (Dosagem/Formato)']}</td>`;
                    tableHtml += `<td style="padding: 10px; border: 1px solid #ccc; font-weight: bold; text-align: right;">${item['Quantidade Dispensada']}</td>`;
                    tableHtml += '</tr>';
                });

                tableHtml += `
                            </table>
                            <!-- REMOÇÃO DE TEXTOS FINAIS E ASSINATURA -->
                            <p style="margin-top: 100px;">&nbsp;</p> 
                        </div>
                    </body>
                    </html>
                `;

                // Criação do link de download
                const mimeType = 'application/msword'; 
                const blob = new Blob([tableHtml], { type: mimeType });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `Relatorio_Gastaveis_${monthYearShort.replace('/', '_')}.doc`); 
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showStatus(`Relatório gerado com ${totalRegistos} registos e descarregado como ficheiro DOC (Word).`, 'text-green-600');

            } catch (e) {
                console.error("Erro ao gerar relatório:", e);
                showStatus(`Erro ao gerar relatório: ${e.message}`, 'text-red-500');
            } finally {
                // Ocultar carregamento do relatório
                btnReport.textContent = originalReportText;
                btnReport.disabled = false;
            }
        }
        
        // Variável de estado para a confirmação de limpeza
        let isClearConfirmed = false;

        /**
         * Limpa todos os registos do LocalStorage com confirmação de clique duplo.
         * @param {HTMLElement} button O botão de limpar.
         */
        function clearDispenses(button) {
            if (isClearConfirmed) {
                // Ação de limpeza confirmada
                try {
                    localStorage.removeItem(STORAGE_KEY);
                    // Resetar imediatamente para evitar cliques acidentais
                    isClearConfirmed = false;
                    button.textContent = 'Limpar TODOS os Registos (Atenção!)';
                    button.classList.replace('bg-orange-600', 'bg-red-600');
                    button.classList.replace('hover:bg-orange-700', 'hover:bg-red-700');
                    
                    showStatus('TODOS os registos foram APAGADOS com sucesso do seu navegador.', 'text-red-700 bg-red-100 p-2 rounded');
                    loadDispenses(); // Atualizar a lista (que estará vazia)
                    cancelEdit(); // Sai do modo de edição
                } catch (e) {
                    console.error("Erro ao limpar o localStorage:", e);
                    showStatus('Erro ao limpar os dados locais.', 'text-red-500');
                }
            } else {
                // Primeiro clique: Pedir confirmação
                isClearConfirmed = true;
                button.textContent = 'CLIQUE NOVAMENTE para Confirmar (Apagar TUDO)';
                button.classList.replace('bg-red-600', 'bg-orange-600');
                button.classList.replace('hover:bg-red-700', 'hover:bg-orange-700');
                showStatus('AVISO: Clique no botão de limpar novamente para apagar permanentemente todos os dados.', 'text-orange-600');

                // Resetar o estado de confirmação após 5 segundos se não houver um segundo clique
                setTimeout(() => {
                    if (isClearConfirmed) {
                        isClearConfirmed = false;
                        button.textContent = 'Limpar TODOS os Registos (Atenção!)';
                        button.classList.replace('bg-orange-600', 'bg-red-600');
                        button.classList.replace('hover:bg-orange-700', 'hover:bg-red-700');
                        showStatus('Confirmação expirada. Tente novamente.', 'text-gray-500');
                    }
                }, 5000);
            }
        }

        // --- Configuração dos Event Listeners ---
        window.onload = function() {
            setupApp(); // Inicialização da aplicação offline

            // Configuração da entrada de voz para cada campo
            setupVoiceRecognition(document.getElementById('productName'), 'Nome do Produto');
            setupVoiceRecognition(document.getElementById('productType'), 'Tipo/Dosagem');
            setupVoiceRecognition(document.getElementById('quantity'), 'Quantidade');

            // Evento de Guardar/Atualizar Dispensa
            document.getElementById('btnSaveDispense').addEventListener('click', saveOrUpdateDispense);

            // Evento de Geração de Relatório
            document.getElementById('btnGenerateReport').addEventListener('click', () => {
                const monthYear = document.getElementById('reportMonth').value;
                generateReport(monthYear);
            });

            // Evento de Limpar Registo Total
            document.getElementById('btnClearDispenses').addEventListener('click', (event) => {
                clearDispenses(event.currentTarget);
            });

            // Definir o mês atual como padrão no seletor de relatórios
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('reportMonth').value = `${year}-${month}`;
        };

    </script>

</body>
</html>
