<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>FarmoGentileza Tech - Relatório Mensal das Fichas de Stock (Online)</title>

    <!-- Tailwind via CDN (VERSÃO ONLINE) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts (ONLINE) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .btn-primary { transition: all 0.2s ease; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn-primary:hover { opacity: 0.95; transform: translateY(-1px); }
        .voice-active { animation: pulse-mic 1s infinite alternate; }
        @keyframes pulse-mic { from { box-shadow: 0 0 0 0 rgba(79,70,229,0.7); } to { box-shadow: 0 0 0 10px rgba(79,70,229,0); } }
    </style>
</head>
<body>

<div class="min-h-screen p-4 sm:p-6 lg:p-8">
    <header class="bg-white shadow-lg rounded-xl p-5 mb-6 flex flex-col items-center">
        <h1 class="text-3xl font-extrabold text-gray-800 text-center">FarmoGentileza</h1>
        <h2 class="text-xl font-semibold text-gray-700 text-center mt-1">FarmoGentileza Tech</h2>
        <p class="text-gray-500 mt-1 text-center">Projeto: Relatório Mensal das Fichas de Stock - Automatização por Entrada de Voz</p>
        <div id="user-info" class="mt-3 text-sm font-medium text-indigo-600 text-center">
            Modo local (offline) — armazenamento no navegador (localStorage).
        </div>
    </header>

    <section class="bg-white shadow-xl rounded-xl p-6 mb-6 border-t-4 border-indigo-500">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
            <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
            Registar Nova Dispensa
        </h2>

        <div class="space-y-4">
            <div>
                <label for="productName" class="block text-sm font-medium text-gray-700">1. Nome do Produto</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="text" id="productName"
                           class="flex-1 block w-full rounded-l-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3 sm:text-sm"
                           placeholder="Ex: Paracetamol 500mg" required>
                    <button id="btnVoiceName" class="bg-indigo-500 text-white p-3 rounded-r-lg hover:bg-indigo-600 transition duration-150 ease-in-out" title="Gravar Nome por Voz">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
                             xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd"
                                                                    d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z"
                                                                    clip-rule="evenodd"></path><path fill-rule="evenodd"
                                                                                                    d="M10 9a6 6 0 00-6 6v2a2 2 0 002 2h8a2 2 0 002-2v-2a6 6 0 00-6-6z"
                                                                                                    clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>

            <div>
                <label for="productType" class="block text-sm font-medium text-gray-700">2. Tipo (Dosagem/Formato)</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="text" id="productType"
                           class="flex-1 block w-full rounded-l-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3 sm:text-sm"
                           placeholder="Ex: Comprimidos / Xarope / 10mg" required>
                    <button id="btnVoiceType" class="bg-indigo-500 text-white p-3 rounded-r-lg hover:bg-indigo-600 transition duration-150 ease-in-out" title="Gravar Tipo por Voz">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
                             xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd"
                                                                    d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z"
                                                                    clip-rule="evenodd"></path><path fill-rule="evenodd"
                                                                                                    d="M10 9a6 6 0 00-6 6v2a2 2 0 002 2h8a2 2 0 002-2v-2a6 6 0 00-6-6z"
                                                                                                    clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>

            <div>
                <label for="quantity" class="block text-sm font-medium text-gray-700">3. Quantidade (Número de Unidades)</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="number" id="quantity"
                           class="flex-1 block w-full rounded-l-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3 sm:text-sm"
                           placeholder="Ex: 50" min="1" required>
                    <button id="btnVoiceQuantity" class="bg-indigo-500 text-white p-3 rounded-r-lg hover:bg-indigo-600 transition duration-150 ease-in-out" title="Gravar Quantidade por Voz">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
                             xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd"
                                                                    d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z"
                                                                    clip-rule="evenodd"></path><path fill-rule="evenodd"
                                                                                                    d="M10 9a6 6 0 00-6 6v2a2 2 0 002 2h8a2 2 0 002-2v-2a6 6 0 00-6-6z"
                                                                                                    clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <button id="btnSaveDispense" class="btn-primary mt-6 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
            <span id="save-text">Registar Dispensa</span>
            <span id="loading-spinner" class="hidden animate-spin h-5 w-5 border-t-2 border-b-2 border-white rounded-full ml-2"></span>
        </button>

        <div id="status-message" class="mt-4 text-center text-sm font-medium hidden"></div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="lg:col-span-1 bg-white shadow-xl rounded-xl p-6 border-t-4 border-yellow-500">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                              d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Gerar Relatório Mensal
            </h2>
            <p class="text-gray-600 mb-4 text-sm">Esta função agrega automaticamente todas as dispensas registadas no período.</p>

            <div class="flex flex-col space-y-3">
                <label for="reportMonth" class="block text-sm font-medium text-gray-700">Mês do Relatório</label>
                <input type="month" id="reportMonth" class="p-2 border border-gray-300 rounded-lg">
            </div>

            <button id="btnGenerateReport" class="btn-primary mt-4 w-full bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2">
                Gerar e Descarregar Relatório (DOC - Word)
            </button>
        </div>

        <div class="lg:col-span-2 bg-white shadow-xl rounded-xl p-6 border-t-4 border-purple-500">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                              d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                Últimas 10 Dispensas (Tempo Real)
            </h2>
            <div id="dispenses-list" class="space-y-3 max-h-96 overflow-y-auto">
                <p class="text-center text-gray-400 p-4" id="no-data-msg">A carregar registos...</p>
            </div>
        </div>

    </section>
</div>

<script type="module">
/**
 * index-online.html
 * Versão ONLINE — usa Tailwind e fontes via CDN.
 * Banco local: localStorage (até MAX_DISPENSES registros).
 *
 * Principais mudanças comparado ao original com Firebase:
 * - Removeu-se toda a dependência do Firebase.
 * - Dados guardados em localStorage sob a chave definida por STORAGE_KEY.
 * - Gera relatórios a partir do localStorage.
 */

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const MAX_DISPENSES = 200;
const STORAGE_KEY = `farmogentileza_dispenses_${appId}`;

/* Estado local similar ao "auth ready" para compatibilidade com o UI */
let isReady = false;
let userId = null;

/* Inicialização: cria userId único e carrega dados */
function setupLocalMode() {
    // Gera/recupera um userId local para identificar os registos (não é autenticação real)
    userId = localStorage.getItem('farmogentileza_userid');
    if (!userId) {
        userId = generateUUID();
        localStorage.setItem('farmogentileza_userid', userId);
    }
    document.getElementById('user-info').textContent = `Modo local — ID: ${userId.substring(0,8)}...`;
    isReady = true;
    loadDispenses(); // carrega e renderiza
}

/* ---------- Utilitários de armazenamento local ---------- */

function getAllDispenses() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr;
    } catch (e) {
        console.error("Erro a ler localStorage:", e);
        return [];
    }
}

function saveAllDispenses(arr) {
    try {
        // Mantém apenas os MAX_DISPENSES mais recentes — arr deve estar em ordem ascendente de tempo (opcional)
        if (!Array.isArray(arr)) arr = [];
        // Ordenar por timestamp crescente (mais antigo primeiro)
        arr.sort((a,b)=> (a.timestamp || 0) - (b.timestamp || 0));
        // Se exceder, remove os mais antigos
        while (arr.length > MAX_DISPENSES) arr.shift();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    } catch (e) {
        console.error("Erro a gravar localStorage:", e);
    }
}

/* ---------- Funções principais (substituem Firestore) ---------- */

/* Salvar nova dispensa */
async function saveDispense() {
    if (!isReady || !userId) {
        showStatus('Sistema não pronto. Aguardar inicialização.', 'text-red-500');
        return;
    }

    const productName = document.getElementById('productName').value.trim();
    const productType = document.getElementById('productType').value.trim();
    const quantityStr = document.getElementById('quantity').value.trim();
    const quantity = parseInt(quantityStr, 10);

    if (!productName || !productType || isNaN(quantity) || quantity <= 0) {
        showStatus('Por favor, preencha todos os campos corretamente (Nome, Tipo e Quantidade > 0).', 'text-red-500');
        return;
    }

    // UI loading
    const btnSave = document.getElementById('btnSaveDispense');
    const saveText = document.getElementById('save-text');
    const spinner = document.getElementById('loading-spinner');
    saveText.textContent = 'A Guardar...';
    spinner.classList.remove('hidden');
    btnSave.disabled = true;

    try {
        const all = getAllDispenses();

        const now = Date.now();
        const iso = new Date(now).toISOString();
        const dispObj = {
            id: generateUUID(),
            productName,
            productType,
            quantityDispensed: quantity,
            timestamp: now,
            isoTimestamp: iso,
            dispenseDate: iso.split('T')[0],
            userId,
        };

        all.push(dispObj);
        saveAllDispenses(all);

        showStatus(`Dispensa de ${productName} (Qtd: ${quantity}) registada com sucesso!`, 'text-green-600');

        // limpar campos
        document.getElementById('productName').value = '';
        document.getElementById('productType').value = '';
        document.getElementById('quantity').value = '';

        // atualizar listagem
        loadDispenses();

    } catch (e) {
        console.error("Erro ao guardar dispensa local:", e);
        showStatus(`Erro ao guardar o registo local. Mensagem: ${e.message}`, 'text-red-500');
    } finally {
        saveText.textContent = 'Registar Dispensa';
        spinner.classList.add('hidden');
        btnSave.disabled = false;
    }
}

/* Carregar e renderizar dispensas (tempo real simulado) */
function loadDispenses() {
    if (!isReady || !userId) return;
    const all = getAllDispenses();

    // ordenar descendente por timestamp
    all.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    // renderiza as 10 mais recentes
    renderDispenses(all.slice(0, 10));
}

/* Renderizar lista no UI */
function renderDispenses(dispenses) {
    const listEl = document.getElementById('dispenses-list');
    listEl.innerHTML = '';

    if (!dispenses || dispenses.length === 0) {
        listEl.innerHTML = '<p class="text-center text-gray-400 p-4">Não há registos de dispensas recentes.</p>';
        return;
    }

    dispenses.forEach(dispense => {
        const timestamp = dispense.timestamp ? new Date(dispense.timestamp) : new Date();
        const timeString = timestamp.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
        const dateString = timestamp.toLocaleDateString('pt-PT');

        const item = document.createElement('div');
        item.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 hover:bg-gray-100 transition duration-150';
        item.innerHTML = `
            <p class="font-bold text-gray-800">${escapeHtml(dispense.productName)}</p>
            <p class="text-sm text-gray-600">Tipo: ${escapeHtml(dispense.productType)}</p>
            <p class="text-lg font-extrabold text-purple-600">Qtd: ${dispense.quantityDispensed}</p>
            <p class="text-xs text-gray-400 mt-1">Registo: ${dateString} às ${timeString}</p>
        `;
        listEl.appendChild(item);
    });
}

/* Geração de relatório .doc (Word) a partir do localStorage */
async function generateReport(monthYearString) {
    if (!isReady || !userId) {
        showStatus('Sistema não pronto. Aguardar inicialização.', 'text-red-500');
        return;
    }
    if (!monthYearString) {
        showStatus('Por favor, selecione o Mês do Relatório.', 'text-red-500');
        return;
    }

    const btnReport = document.getElementById('btnGenerateReport');
    const originalReportText = btnReport.textContent;
    btnReport.textContent = 'A Gerar...';
    btnReport.disabled = true;

    showStatus('A processar dados para o relatório...', 'text-yellow-600');

    try {
        const all = getAllDispenses();
        const aggregated = {};
        let totalRegistos = 0;

        all.forEach(data => {
            const dispDate = data.dispenseDate;
            if (dispDate && dispDate.startsWith(monthYearString)) {
                const key = `${data.productName} | ${data.productType}`;
                if (!aggregated[key]) {
                    aggregated[key] = {
                        'Nome do Produto': data.productName,
                        'Tipo (Dosagem/Formato)': data.productType,
                        'Quantidade Dispensada': 0,
                    };
                }
                aggregated[key]['Quantidade Dispensada'] += Number(data.quantityDispensed || 0);
                totalRegistos++;
            }
        });

        if (totalRegistos === 0) {
            showStatus('Não foram encontrados registos para o mês selecionado.', 'text-red-500');
            return;
        }

        const dataArray = Object.values(aggregated);

        // Construir HTML compatível com Word
        let tableHtml = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='utf-8'></head>
            <body>
                <div style="font-family: Arial, sans-serif;">
                    <h1 style="text-align: center; color: #1e3a8a; margin-bottom: 5px;">FarmoGentileza</h1>
                    <h2 style="text-align: center; color: #4a5568; margin-top: 0; margin-bottom: 20px; font-size: 1.5em;">FarmoGentileza Tech - Relatório Mensal das Fichas de Stock (${monthYearString})</h2>
                    <table border="1" style="width: 100%; border-collapse: collapse;">
                        <tr style="background-color: #e0f2fe; color: #1e3a8a; font-weight: bold;">
                            <th style="padding: 12px; text-align: left; border: 1px solid #aaa;">Nome do Produto</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #aaa;">Tipo (Dosagem/Formato)</th>
                            <th style="padding: 12px; text-align: right; border: 1px solid #aaa;">Quantidade Dispensada</th>
                        </tr>
        `;

        dataArray.forEach(item => {
            tableHtml += '<tr>';
            tableHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${escapeHtml(item['Nome do Produto'])}</td>`;
            tableHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${escapeHtml(item['Tipo (Dosagem/Formato)'])}</td>`;
            tableHtml += `<td style="padding: 10px; border: 1px solid #ccc; font-weight: bold; text-align: right;">${item['Quantidade Dispensada']}</td>`;
            tableHtml += '</tr>';
        });

        tableHtml += `
                    </table>
                    <p style="margin-top: 30px; font-size: 14px;">Total de Dispensas únicas agregadas: ${dataArray.length}.</p>
                    <p style="margin-top: 50px;">_________________________</p>
                    <p>Assinatura do Farmacêutico</p>
                </div>
            </body>
            </html>
        `;

        const mimeType = 'application/msword';
        const blob = new Blob([tableHtml], { type: mimeType });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `Relatorio_Farmacia_${monthYearString}.doc`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showStatus(`Relatório gerado com ${totalRegistos} registos e descarregado como ficheiro DOC (Word).`, 'text-green-600');

    } catch (e) {
        console.error("Erro ao gerar relatório:", e);
        showStatus(`Erro ao gerar relatório: ${e.message}`, 'text-red-500');
    } finally {
        btnReport.textContent = originalReportText;
        btnReport.disabled = false;
    }
}

/* ---------- Voice recognition (mantém-se como no original) ---------- */

function setupVoiceRecognition(inputElement, prompt) {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showStatus('O reconhecimento de voz não é suportado no seu browser/dispositivo.', 'text-red-500');
        return null;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'pt-PT';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    // Encontrar o botão (assume que o botão é o próximo irmão na DOM)
    const parent = inputElement.parentElement;
    const voiceButton = parent ? parent.querySelector('button') : null;

    if (!voiceButton) return null;

    voiceButton.onclick = () => {
        try {
            recognition.start();
            inputElement.value = '';
            voiceButton.classList.add('voice-active');
            showStatus(`A ouvir para ${prompt}... Diga claramente.`, 'text-indigo-600');
        } catch (e) {
            console.warn("Erro ao iniciar reconhecimento de voz:", e);
            recognition.stop();
            voiceButton.classList.remove('voice-active');
        }
    };

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        inputElement.value = transcript.trim();
        showStatus(`Registo de ${prompt} capturado: "${transcript.trim()}"`, 'text-green-600');

        if (inputElement.id === 'productName') {
            document.getElementById('productType').focus();
        } else if (inputElement.id === 'productType') {
            document.getElementById('quantity').focus();
        }
    };

    recognition.onerror = (event) => {
        console.error('Erro de Reconhecimento de Voz:', event.error);
        voiceButton.classList.remove('voice-active');
        let errorMsg = 'Erro na voz. Verifique a permissão do microfone.';
        if (event.error === 'not-allowed') {
            errorMsg = 'Acesso ao Microfone negado. Por favor, permita no seu dispositivo.';
        }
        showStatus(errorMsg, 'text-red-500');
    };

    recognition.onend = () => {
        voiceButton.classList.remove('voice-active');
    };

    return recognition;
}

/* ---------- Pequenas funções utilitárias ---------- */

function showStatus(message, className) {
    const statusEl = document.getElementById('status-message');
    statusEl.textContent = message;
    statusEl.className = `mt-4 text-center text-sm font-medium ${className}`;
    statusEl.style.display = 'block';
    setTimeout(() => {
        statusEl.style.display = 'none';
    }, 5000);
}

function generateUUID() {
    // Simples UUID v4 (suficiente para ids locais)
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
}

/* ---------- Event listeners e inicialização ---------- */

window.onload = function() {
    // Inicializa modo local (substitui autenticação Firebase)
    setupLocalMode();

    // Configura voz
    setupVoiceRecognition(document.getElementById('productName'), 'Nome do Produto');
    setupVoiceRecognition(document.getElementById('productType'), 'Tipo/Dosagem');
    setupVoiceRecognition(document.getElementById('quantity'), 'Quantidade');

    // Eventos principais
    document.getElementById('btnSaveDispense').addEventListener('click', saveDispense);
    document.getElementById('btnGenerateReport').addEventListener('click', () => {
        const monthYear = document.getElementById('reportMonth').value;
        generateReport(monthYear);
    });

    // Preenche o seletor de mês com o mês atual
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    document.getElementById('reportMonth').value = `${year}-${month}`;
};
</script>

</body>
</html>
