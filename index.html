<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmoGentileza Tech - Relatório Mensal das Fichas de Stock</title>
    <!-- Carregamento do Tailwind CSS para um design moderno e responsivo --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter (padrão de design) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Estilo para botões de ação e voz */
        .btn-primary {
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .voice-active {
            animation: pulse-mic 1s infinite alternate;
        }
        @keyframes pulse-mic {
            from { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
            to { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
        }
    </style>
</head>
<body>

    <!-- Estrutura Principal da Aplicação --><div class="min-h-screen p-4 sm:p-6 lg:p-8">

        <!-- Cabeçalho --><header class="bg-white shadow-lg rounded-xl p-5 mb-6 flex flex-col items-center">
            <!-- LOGO REMOVIDO: Como a imagem não carregou, removemos a tag <img> para evitar o erro visual. --><h1 class="text-3xl font-extrabold text-gray-800 text-center">FarmoGentileza</h1>
            <h2 class="text-xl font-semibold text-gray-700 text-center mt-1">FarmoGentileza Tech</h2>
            <p class="text-gray-500 mt-1 text-center">Projeto: Relatório Mensal das Fichas de Stock - Automatização por Entrada de Voz</p>
            <div id="user-info" class="mt-3 text-sm font-medium text-indigo-600 text-center">
                Aguardando autenticação...
            </div>
        </header>

        <!-- Seção de Entrada de Dados (A Ficha de Stock Digital) --><section class="bg-white shadow-xl rounded-xl p-6 mb-6 border-t-4 border-indigo-500">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                Registar Nova Dispensa
            </h2>

            <!-- Formulário de Registo --><div class="space-y-4">
                <div>
                    <label for="productName" class="block text-sm font-medium text-gray-700">1. Nome do Produto</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="productName" class="flex-1 block w-full rounded-l-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3 sm:text-sm" placeholder="Ex: Paracetamol 500mg" required>
                        <button id="btnVoiceName" class="bg-indigo-500 text-white p-3 rounded-r-lg hover:bg-indigo-600 transition duration-150 ease-in-out" title="Gravar Nome por Voz">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M10 9a6 6 0 00-6 6v2a2 2 0 002 2h8a2 2 0 002-2v-2a6 6 0 00-6-6z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>

                <div>
                    <label for="productType" class="block text-sm font-medium text-gray-700">2. Tipo (Dosagem/Formato)</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="text" id="productType" class="flex-1 block w-full rounded-l-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3 sm:text-sm" placeholder="Ex: Comprimidos / Xarope / 10mg" required>
                        <button id="btnVoiceType" class="bg-indigo-500 text-white p-3 rounded-r-lg hover:bg-indigo-600 transition duration-150 ease-in-out" title="Gravar Tipo por Voz">
                             <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M10 9a6 6 0 00-6 6v2a2 2 0 002 2h8a2 2 0 002-2v-2a6 6 0 00-6-6z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>

                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-700">3. Quantidade (Número de Unidades)</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="number" id="quantity" class="flex-1 block w-full rounded-l-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3 sm:text-sm" placeholder="Ex: 50" min="1" required>
                        <button id="btnVoiceQuantity" class="bg-indigo-500 text-white p-3 rounded-r-lg hover:bg-indigo-600 transition duration-150 ease-in-out" title="Gravar Quantidade por Voz">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M10 9a6 6 0 00-6 6v2a2 2 0 002 2h8a2 2 0 002-2v-2a6 6 0 00-6-6z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Botão de Submissão --><button id="btnSaveDispense" class="btn-primary mt-6 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                <span id="save-text">Registar Dispensa</span>
                <span id="loading-spinner" class="hidden animate-spin h-5 w-5 border-t-2 border-b-2 border-white rounded-full ml-2"></span>
            </button>

            <!-- Mensagens de Estado --><div id="status-message" class="mt-4 text-center text-sm font-medium hidden"></div>

        </section>

        <!-- Seção de Relatórios e Dados Recentes --><section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Card de Geração de Relatório --><div class="lg:col-span-1 bg-white shadow-xl rounded-xl p-6 border-t-4 border-yellow-500">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Gerar Relatório Mensal
                </h2>
                <p class="text-gray-600 mb-4 text-sm">Esta função agrega automaticamente todas as dispensas registadas no período, eliminando a contagem manual da ficha de stock.</p>

                <div class="flex flex-col space-y-3">
                    <label for="reportMonth" class="block text-sm font-medium text-gray-700">Mês do Relatório</label>
                    <input type="month" id="reportMonth" class="p-2 border border-gray-300 rounded-lg">
                </div>

                <!-- Botão alterado para refletir o novo formato (.doc) --><button id="btnGenerateReport" class="btn-primary mt-4 w-full bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2">
                    Gerar e Descarregar Relatório (DOC - Word)
                </button>
            </div>

            <!-- Lista de Registos Recentes (Dados em Tempo Real) --><div class="lg:col-span-2 bg-white shadow-xl rounded-xl p-6 border-t-4 border-purple-500">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                    Últimas 10 Dispensas (Tempo Real)
                </h2>
                <div id="dispenses-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-center text-gray-400 p-4" id="no-data-msg">A carregar registos...</p>
                </div>
            </div>

        </section>

    </div>

    <!-- Script de Configuração e Lógica da Aplicação --><script type="module">
        // Importações obrigatórias do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Variáveis Globais (MANDATÓRIAS)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        setLogLevel('Debug'); // Para ver logs de depuração do Firestore

        /**
         * Inicializa o Firebase e a Autenticação.
         */
        async function setupFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Configurar o listener de estado de autenticação
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-info').textContent = `Utilizador: ${userId.substring(0, 8)}... (ID Completo: ${userId})`;
                        isAuthReady = true;
                        loadDispenses(); // Carregar dados assim que a autenticação estiver pronta
                    } else {
                        // Tentar autenticar com o token customizado ou anonimamente
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                document.getElementById('user-info').textContent = 'Erro ao inicializar o sistema de dados.';
            }
        }

        /**
         * Configura o sistema de Reconhecimento de Voz.
         * Utiliza o Web Speech API (o que simula a funcionalidade de voz nativa do Android).
         * @param {HTMLElement} inputElement O campo de input a preencher.
         * @param {string} prompt A mensagem de prompt para o utilizador.
         */
        function setupVoiceRecognition(inputElement, prompt) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showStatus('O reconhecimento de voz não é suportado no seu browser/dispositivo.', 'text-red-500');
                return null;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-PT'; // Definir para Português
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const voiceButton = inputElement.nextElementSibling; // Assume que o botão de voz é o próximo irmão

            voiceButton.onclick = () => {
                try {
                    recognition.start();
                    inputElement.value = ''; // Limpar antes de começar a ouvir
                    voiceButton.classList.add('voice-active');
                    showStatus(`A ouvir para ${prompt}... Diga claramente.`, 'text-indigo-600');
                } catch (e) {
                    // Ocorre se for tentado iniciar enquanto já está a ouvir
                    console.warn("Reconhecimento de Voz já ativo ou erro ao iniciar:", e);
                    recognition.stop();
                    voiceButton.classList.remove('voice-active');
                }
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                inputElement.value = transcript.trim();
                showStatus(`Registo de ${prompt} capturado: "${transcript.trim()}"`, 'text-green-600');

                // Tentar automaticamente mover para o próximo campo (para otimizar o fluxo)
                if (inputElement.id === 'productName') {
                    document.getElementById('productType').focus();
                    document.getElementById('btnVoiceType').click(); // Iniciar voz para o próximo campo
                } else if (inputElement.id === 'productType') {
                    document.getElementById('quantity').focus();
                    document.getElementById('btnVoiceQuantity').click(); // Iniciar voz para a quantidade
                }
                // O campo de quantidade não avança automaticamente; requer confirmação.
            };

            recognition.onerror = (event) => {
                console.error('Erro de Reconhecimento de Voz:', event.error);
                voiceButton.classList.remove('voice-active');
                let errorMsg = 'Erro na voz. Verifique a permissão do microfone.';
                if (event.error === 'not-allowed') {
                    errorMsg = 'Acesso ao Microfone negado. Por favor, permita no seu dispositivo.';
                }
                showStatus(errorMsg, 'text-red-500');
            };

            recognition.onend = () => {
                voiceButton.classList.remove('voice-active');
            };
        }

        /**
         * Exibe uma mensagem de estado temporária.
         * @param {string} message A mensagem a exibir.
         * @param {string} className A classe CSS para cor/estilo.
         */
        function showStatus(message, className) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `mt-4 text-center text-sm font-medium ${className}`;
            statusEl.style.display = 'block';

            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        /**
         * Guarda um novo registo de dispensa no Firestore.
         */
        async function saveDispense() {
            if (!isAuthReady || !userId) {
                showStatus('Sistema não autenticado. A aguardar...', 'text-red-500');
                return;
            }

            const productName = document.getElementById('productName').value.trim();
            const productType = document.getElementById('productType').value.trim();
            const quantityStr = document.getElementById('quantity').value.trim();
            const quantity = parseInt(quantityStr, 10);

            if (!productName || !productType || isNaN(quantity) || quantity <= 0) {
                showStatus('Por favor, preencha todos os campos corretamente (Nome, Tipo e Quantidade > 0).', 'text-red-500');
                return;
            }

            // Exibir carregamento
            const btnSave = document.getElementById('btnSaveDispense');
            const saveText = document.getElementById('save-text');
            const spinner = document.getElementById('loading-spinner');
            saveText.textContent = 'A Guardar...';
            spinner.classList.remove('hidden');
            btnSave.disabled = true;

            try {
                // Caminho da coleção de dados privados: /artifacts/{appId}/users/{userId}/{your_collection_name}
                const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/dispenses`), {
                    productName: productName,
                    productType: productType,
                    quantityDispensed: quantity,
                    timestamp: serverTimestamp(), // Uso do timestamp do servidor
                    dispenseDate: new Date().toISOString().split('T')[0], // Data no formato YYYY-MM-DD
                    userId: userId,
                });

                showStatus(`Dispensa de ${productName} (Qtd: ${quantity}) registada com sucesso!`, 'text-green-600');

                // Limpar campos após o sucesso
                document.getElementById('productName').value = '';
                document.getElementById('productType').value = '';
                document.getElementById('quantity').value = '';

            } catch (e) {
                console.error("Erro ao adicionar documento:", e);
                showStatus(`Erro ao guardar o registo: ${e.message}`, 'text-red-500');
            } finally {
                // Ocultar carregamento
                saveText.textContent = 'Registar Dispensa';
                spinner.classList.add('hidden');
                btnSave.disabled = false;
            }
        }

        /**
         * Carrega os registos de dispensa em tempo real usando onSnapshot.
         */
        function loadDispenses() {
            if (!isAuthReady || !userId || !db) return;

            // Ordenar por data (mais recente primeiro)
            const dispensesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/dispenses`);

            // Nota: Evito 'orderBy' em onSnapshot, conforme a instrução de evitar indexação.
            // A ordenação será feita em memória (por timestamp) após a receção dos dados.
            onSnapshot(dispensesCollectionRef, (snapshot) => {
                const dispenses = [];
                snapshot.forEach((doc) => {
                    dispenses.push({ id: doc.id, ...doc.data() });
                });

                // Ordenar em memória (descendente) e mostrar os 10 mais recentes
                dispenses.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                renderDispenses(dispenses.slice(0, 10));
            }, (error) => {
                console.error("Erro ao carregar dispensas em tempo real:", error);
                document.getElementById('no-data-msg').textContent = 'Erro ao carregar dados.';
            });
        }

        /**
         * Renderiza a lista de dispensas recentes no UI.
         * @param {Array} dispenses Array de objetos de dispensa.
         */
        function renderDispenses(dispenses) {
            const listEl = document.getElementById('dispenses-list');
            listEl.innerHTML = '';

            if (dispenses.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-400 p-4">Não há registos de dispensas recentes.</p>';
                return;
            }

            dispenses.forEach(dispense => {
                const timestamp = dispense.timestamp?.toDate ? dispense.timestamp.toDate() : new Date();
                const timeString = timestamp.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
                const dateString = timestamp.toLocaleDateString('pt-PT');

                const item = document.createElement('div');
                item.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 hover:bg-gray-100 transition duration-150';
                item.innerHTML = `
                    <p class="font-bold text-gray-800">${dispense.productName}</p>
                    <p class="text-sm text-gray-600">Tipo: ${dispense.productType}</p>
                    <p class="text-lg font-extrabold text-purple-600">Qtd: ${dispense.quantityDispensed}</p>
                    <p class="text-xs text-gray-400 mt-1">Registo: ${dateString} às ${timeString}</p>
                `;
                listEl.appendChild(item);
            });
        }

        /**
         * Gera o relatório mensal no formato HTML (compatível com Word).
         * @param {string} monthYearString Data no formato 'YYYY-MM'.
         */
        async function generateReport(monthYearString) {
            if (!isAuthReady || !userId || !db) {
                showStatus('Sistema não autenticado. A aguardar...', 'text-red-500');
                return;
            }

            if (!monthYearString) {
                showStatus('Por favor, selecione o Mês do Relatório.', 'text-red-500');
                return;
            }

            showStatus('A processar dados para o relatório...', 'text-yellow-600');
            
            // Note: Não há necessidade de extrair ano/mês para filtragem neste protótipo.
            // A filtragem pelo campo 'dispenseDate' formatado é mais simples.
            
            try {
                const dispensesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/dispenses`);
                const querySnapshot = await getDocs(dispensesCollectionRef);
                
                const aggregatedData = {};
                let totalRegistos = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const dispDate = data.dispenseDate; // YYYY-MM-DD

                    if (dispDate && dispDate.startsWith(monthYearString)) {
                        const key = `${data.productName} | ${data.productType}`;
                        
                        if (!aggregatedData[key]) {
                            aggregatedData[key] = {
                                'Nome do Produto': data.productName,
                                'Tipo (Dosagem/Formato)': data.productType,
                                'Quantidade Dispensada': 0,
                            };
                        }
                        
                        aggregatedData[key]['Quantidade Dispensada'] += data.quantityDispensed;
                        totalRegistos++;
                    }
                });

                if (totalRegistos === 0) {
                    showStatus('Não foram encontrados registos para o mês selecionado.', 'text-red-500');
                    return;
                }

                // --- Geração do HTML para o Word (.doc) ---
                const dataArray = Object.values(aggregatedData);
                
                // Cabeçalhos da tabela
                const headers = ['Nome do Produto', 'Tipo (Dosagem/Formato)', 'Quantidade Dispensada'];

                // Estrutura do documento HTML (com estilos embutidos para compatibilidade com o Word)
                let tableHtml = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head><meta charset='utf-8'></head>
                    <body>
                        <div style="font-family: Arial, sans-serif;">
                            <!-- LOGO REMOVIDO DO RELATÓRIO TAMBÉM --><h1 style="text-align: center; color: #1e3a8a; margin-bottom: 5px;">FarmoGentileza</h1>
                            <h2 style="text-align: center; color: #4a5568; margin-top: 0; margin-bottom: 20px; font-size: 1.5em;">FarmoGentileza Tech - Relatório Mensal das Fichas de Stock (${monthYearString})</h2>
                            <table border="1" style="width: 100%; border-collapse: collapse;">
                                <!-- Cabeçalho --><tr style="background-color: #e0f2fe; color: #1e3a8a; font-weight: bold;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #aaa;">Nome do Produto</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #aaa;">Tipo (Dosagem/Formato)</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #aaa;">Quantidade Dispensada</th>
                                </tr>
                `;

                // Linhas da Tabela
                dataArray.forEach(item => {
                    tableHtml += '<tr>';
                    tableHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${item['Nome do Produto']}</td>`;
                    tableHtml += `<td style="padding: 10px; border: 1px solid #ccc;">${item['Tipo (Dosagem/Formato)']}</td>`;
                    tableHtml += `<td style="padding: 10px; border: 1px solid #ccc; font-weight: bold; text-align: right;">${item['Quantidade Dispensada']}</td>`;
                    tableHtml += '</tr>';
                });

                tableHtml += `
                            </table>
                            <p style="margin-top: 30px; font-size: 14px;">Total de Dispensas únicas agregadas: ${dataArray.length}.</p>
                            <p style="margin-top: 50px;">_________________________</p>
                            <p>Assinatura do Farmacêutico</p>
                        </div>
                    </body>
                    </html>
                `;

                // Criação do link de download
                // Usar 'application/msword' e a extensão '.doc' para que o Word reconheça o ficheiro
                const mimeType = 'application/msword'; 
                const blob = new Blob([tableHtml], { type: mimeType });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `Relatorio_Farmacia_${monthYearString}.doc`); // Extensão alterada para .doc
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showStatus(`Relatório gerado com ${totalRegistos} registos e descarregado como ficheiro DOC (Word).`, 'text-green-600');

            } catch (e) {
                console.error("Erro ao gerar relatório:", e);
                showStatus(`Erro ao gerar relatório: ${e.message}`, 'text-red-500');
            }
        }

        // --- Configuração dos Event Listeners ---
        window.onload = function() {
            setupFirebase();

            // Configuração da entrada de voz para cada campo
            setupVoiceRecognition(document.getElementById('productName'), 'Nome do Produto');
            setupVoiceRecognition(document.getElementById('productType'), 'Tipo/Dosagem');
            setupVoiceRecognition(document.getElementById('quantity'), 'Quantidade');

            // Evento de Guardar Dispensa
            document.getElementById('btnSaveDispense').addEventListener('click', saveDispense);

            // Evento de Geração de Relatório
            document.getElementById('btnGenerateReport').addEventListener('click', () => {
                const monthYear = document.getElementById('reportMonth').value;
                generateReport(monthYear);
            });

            // Definir o mês atual como padrão no seletor de relatórios
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('reportMonth').value = `${year}-${month}`;
        };

    </script>

</body>
</html>